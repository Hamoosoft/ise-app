# ==========================================================
# ğŸ“¦ CI/CD-Pipeline fÃ¼r ise-app
# ----------------------------------------------------------
# Diese Pipeline:
#  - baut & testet dein Java-Projekt mit Maven
#  - lÃ¤dt Testreports & Artefakte hoch
#  - baut automatisch ein Docker-Image
#  - taggt es sinnvoll (sha, latest, v1.x)
#  - pusht es in GitHub Container Registry (GHCR)
# ----------------------------------------------------------
# Autor: Mohammed & Rania âœ¨
# ==========================================================

name: CI Pipeline

# ğŸ’¡ GitHub Token Rechte:
#  ErmÃ¶glichen Zugriff auf Code + GHCR Push
permissions:
  contents: read
  packages: write

# â±ï¸ verhindert doppelte LÃ¤ufe (z. B. bei vielen Pushes gleichzeitig)
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

# ğŸ“¡ Wann lÃ¤uft die Pipeline?
on:
  push:
    branches: [ "main" ]     # bei jedem Push auf main
    tags:     [ "v*" ]       # zusÃ¤tzlich bei Release-Tags (z. B. v1.0.0)
  pull_request:              # bei PRs (nur Build & Tests)

jobs:
  build:
    runs-on: ubuntu-latest

    env:
      IMAGE_NAME: ghcr.io/${{ github.repository }}/ise-app

    steps:
      # --------------------------------------------------------
      # ğŸ§¾ Schritt 1 â€“ Code holen
      - name: Check out code
        uses: actions/checkout@v4

      # â˜• Schritt 2 â€“ Java 17 installieren
      - name: Set up Java 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: '17'

      # ğŸ“¦ Schritt 3 â€“ Maven Cache (schnellerer Build)
      - name: Cache Maven dependencies
        uses: actions/cache@v4
        with:
          path: ~/.m2/repository
          key: ${{ runner.os }}-maven-${{ hashFiles('**/pom.xml') }}
          restore-keys: ${{ runner.os }}-maven-

      # ğŸ§ª Schritt 4 â€“ Build & Tests
      - name: Build and test with Maven
        run: mvn -B -ntp clean verify

      # ğŸ“Š Schritt 5 â€“ Testreports hochladen
      - name: Upload surefire reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: surefire-reports
          path: |
            **/target/surefire-reports/**
            **/target/failsafe-reports/**
          if-no-files-found: ignore

      # ğŸ’¾ Schritt 6 â€“ gebaute JAR-Datei speichern (optional)
      - name: Upload application JAR
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: ise-app-jar
          path: |
            **/target/*.jar
          if-no-files-found: warn

      # --------------------------------------------------------
      # ğŸ³ Docker Build & Push
      # --------------------------------------------------------

      # ğŸ”‘ Schritt 7 â€“ Login bei GHCR (GitHub Container Registry)
      - name: Log in to GitHub Container Registry
        if: github.event_name != 'pull_request'
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      # ğŸ·ï¸ Schritt 8 â€“ automatische Tags/Labels generieren
      - name: Docker metadata
        if: github.event_name != 'pull_request'
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.IMAGE_NAME }}
          tags: |
            # KÃ¼rzere Commit-ID (z. B. :3b7f1d2)
            type=sha,format=short
            # latest nur auf main
            type=raw,value=latest,enable=${{ github.ref == 'refs/heads/main' }}
            # Git-Tag â†’ Image-Tag (z. B. v1.0.0)
            type=ref,event=tag

      # âš™ï¸ Schritt 9 â€“ Docker Image bauen & pushen
      - name: Build and (conditionally) push Docker image
        uses: docker/build-push-action@v6
        with:
          context: .
          push: ${{ github.event_name != 'pull_request' }}
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}

      # ğŸ§¾ Schritt 10 â€“ Ausgabe der verÃ¶ffentlichten Tags
      - name: Show published image tags
        if: github.event_name != 'pull_request'
        run: |
          echo "âœ… Published image tags:"
          echo "${{ steps.meta.outputs.tags }}"
